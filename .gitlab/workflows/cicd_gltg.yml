stages:
    - validate
    - plan
    - stage 1 deploy
    - docker push
    - stage 2 deploy


image:
    name: hashicorp/terraform
    entrypoint:
        - '/usr/bin/env'
        - 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'

before_script:
    - mkdir ~/.terraform.d
    - sed -i "s/_TERRAFORM_TOKEN_/$TF_TOKEN/g" credentials.tfrc.json 
    - cat credentials.tfrc.json 
    - cp credentials.tfrc.json ~/.terraform.d
    - cd infrastructure/terraform/gcp
    - cp $GOOGLE_CREDENTIALS credentials.json
    - terraform --version
    - terraform init
    
validate:
    stage: validate
    script:
        - terraform validate

plan:
    stage: plan
    script:
        - terraform plan -var gcp_project=$GCP_PROJECT_ID 
        - terraform plan -var gcp_project=$GCP_PROJECT_ID -var stage2_deploy=true
    dependencies:
        - validate

stage-1-deploy:
    stage: stage 1 deploy
    script:
        - terraform apply -auto-approve -var gcp_project=$GCP_PROJECT_ID 

docker-push:
    stage: docker push
    image: docker:latest
    services:
        - docker:dind
    before_script:
        - docker --version
    script:
        - echo 'abc'


